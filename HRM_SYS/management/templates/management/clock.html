{% extends 'management/base.html' %}

{% block content %}
     <!-- create camera modal here-->

     






      <!-- partial -->
      <div class="main-panel">        
        <div class="content-wrapper">
          <div class="row">
            <div class="col-md-6 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">clock in <i class="fa fa-clock"></i></h4>
                  <form class="forms-sample">
                    <div class="form-group">
                     <input type="text" class="form-control" id="longitudes" readonly>
                     
                  </div>
                  <div class="form-group">
                    <input type="text" class="form-control" id="latitudes" readonly>
                    
                 </div>
                 <div class="form-group">
                  <input type="text" class="form-control" id="image_info" readonly>
                  
               </div>
               <div class="form-group">
                <input type="text" class="form-control" id="my_ip" readonly>
                
             </div>
                  </form>
                  <p class="card-description" style="color:gree" id="video_msg">
                   
                  </p>
                  <button class="btn btn-primary btn-circle" style="margin: 5px;0px;width:200px;height:200px;border-radius:35px;" >
                     <div style="color:white; font-weight: bold; font-size: x-large;" id="timenow"></div>
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Image set</h4>
                  <p class="card-description">
                   capture image to complete process
                  </p>
                  <div class="row">
                    <div class="col" >
                      <video id="video" width="280" height="240"  autoplay></video>
                    </div>
                    
                    <div class="col">

                      <canvas id="canvas" width="285" height="200" ></canvas>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col">
                  <button class="btn btn-circle" id="click-photo"><i class="ti-image"></i>take photo</button>
                  </div>
                  <div class="col">
                    <button class="btn btn-primary" onclick="subClockin();"><i class="ti-save"></i>submit</button>
                  </div>
                  </div>
                  <br>
                  
                </div>
              </div>
            </div>
            <div class="col-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Basic form elements</h4>
                  <p class="card-description">
                    Basic form elements
                  </p>
                  <form class="forms-sample">
                    <div class="form-group">
                      <label for="exampleInputName1">Name</label>
                      <input type="text" class="form-control" id="exampleInputName1" placeholder="Name">
                    </div>
                    <div class="form-group">
                      <label for="exampleInputEmail3">Email address</label>
                      <input type="email" class="form-control" id="exampleInputEmail3" placeholder="Email">
                    </div>
                    <div class="form-group">
                      <label for="exampleInputPassword4">Password</label>
                      <input type="password" class="form-control" id="exampleInputPassword4" placeholder="Password">
                    </div>
                    <div class="form-group">
                      <label for="exampleSelectGender">Gender</label>
                        <select class="form-control" id="exampleSelectGender">
                          <option>Male</option>
                          <option>Female</option>
                        </select>
                      </div>
                    <div class="form-group">
                      <label>File upload</label>
                      <input type="file" name="img[]" class="file-upload-default">
                      <div class="input-group col-xs-12">
                        <input type="text" class="form-control file-upload-info" disabled placeholder="Upload Image">
                        <span class="input-group-append">
                          <button class="file-upload-browse btn btn-primary" type="button">Upload</button>
                        </span>
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="exampleInputCity1">City</label>
                      <input type="text" class="form-control" id="exampleInputCity1" placeholder="Location">
                    </div>
                    <div class="form-group">
                      <label for="exampleTextarea1">Textarea</label>
                      <textarea class="form-control" id="exampleTextarea1" rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary mr-2">Submit</button>
                    <button class="btn btn-light">Cancel</button>
                  </form>
                </div>
              </div>
            </div>
            
          </div>
        </div>
        <!-- content-wrapper ends -->
        <!-- partial:../../partials/_footer.html -->
        <footer class="footer">
          <div class="d-sm-flex justify-content-center justify-content-sm-between">
            <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright Â© 2021.  Premium <a href="https://www.bootstrapdash.com/" target="_blank">Bootstrap admin template</a> from BootstrapDash. All rights reserved.</span>
            <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Hand-crafted & made with <i class="ti-heart text-danger ml-1"></i></span>
          </div>
        </footer>
        <!-- partial -->
      </div>

    <script>
      // creating live clock

      function startTime() {
          const today = new Date();
          let h = today.getHours();
          let m = today.getMinutes();
          let s = today.getSeconds();
          m = checkTime(m);
          s = checkTime(s);
          document.getElementById('timenow').innerHTML =  h + ":" + m + ":" + s;
          if(h>8){
            document.getElementById('timenow').style.color = "red";
          }
          setTimeout(startTime, 1000);
      }

        function checkTime(i) {
          if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
          return i;
        }
        startTime()

    // propmp locationn and camera 

       function getLoc(){
        if(document.getElementById("longitudes").value == ''){
            if(navigator.geolocation){

              navigator.geolocation.getCurrentPosition(getCoord);
              $.getJSON("https://api.ipify.org?format=json", function(data) {
         
         // Setting text of element P with id gfg
        
         document.getElementById("my_ip").value = data.ip
     })
              
            }else{
                
                alert("your device browser does not support")
            }
              
              
          }else{

              alert("details already recorded")
          }
        }
       function getCoord(position){

          var lat = position.coords.latitude;
          var long = position.coords.longitude;
          document.getElementById("longitudes").value = long
          document.getElementById("latitudes").value = lat
       }


       let camera_button = document.querySelector("#timenow");
        let video = document.querySelector("#video");
        let click_button = document.querySelector("#click-photo");
        let canvas = document.querySelector("#canvas");

        camera_button.addEventListener('click', async function() {
            let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          video.srcObject = stream;
          getLoc();
          document.getElementById("video_msg").innerHTML = "scroll down video initiated";

        });

        click_button.addEventListener('click', function() {
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            let image_data_url = canvas.toDataURL('image/jpeg');

            // data url of the image
            //console.log(image_data_url);
            document.getElementById("image_info").value = image_data_url
            video.srcObject.getVideoTracks().forEach(track => track.stop());
        });

      // submit clock in details 

        function subClockin(){

             alert("done")
            $.ajax({
              
              type:"POST",
              url:"{% url 'management-clock' %}",
              data: {

                 latitude: $("#latitudes").val(),
                 longitude: $("#longitudes").val(),
                 image_str:$("#image_info").val(),
                 csrfmiddlewaretoken:'{{ csrf_token }}'
              },

              success:function(data,status){
                 alert(data)
              }
            })
        }

    </script>
  {% endblock content %}

  