{% extends 'management/base.html' %}
{% block content %}
{% load cache %}
<style>
  .parent {
    overflow-y: scroll;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* Internet Explorer 10+ */
}
.parent::-webkit-scrollbar { /* WebKit */
    width: 0;
    height: 0;
}
</style>
      <!-- partial -->
      <div class="main-panel">
        <div class="content-wrapper">
          <div class="row">
            <div class="col-md-12 grid-margin">
              <div class="row">
                <div class="col-12 col-xl-8 mb-4 mb-xl-0">
                  <h3 class="font-weight-bold">Welcome</h3>
                  <h4 class="font-weight-normal mb-0" style="color:yellowgreen"> {{user.username}}@{{user.profile.first}} </h4>
                  <div id="loaders5" style="display: none;">
                    <div class="spinner-grow text-primary" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <div class="spinner-grow text-secondary" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <div class="spinner-grow text-success" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    </div>
                 
                                        </div>
                <div class="col-12 col-xl-4">
                  <small>cached!! updates reflect after 15 mins, clear cache for upadtes to reflect now.</small>
                  <button class="btn btn-outline" onclick="clearCache()"><svg width="34px" height="34px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path fill="#10f436" d="M13.9907,1.31133017e-07 C14.8816,1.31133017e-07 15.3277,1.07714 14.6978,1.70711 L13.8556,2.54922 C14.421,3.15654 14.8904,3.85028 15.2448,4.60695 C15.8028,5.79836 16.0583,7.109 15.9888,8.42277 C15.9193,9.73654 15.5268,11.0129 14.8462,12.1388 C14.1656,13.2646 13.2178,14.2053 12.0868,14.8773 C10.9558,15.5494 9.67655,15.9322 8.3623,15.9918 C7.04804,16.0514 5.73937,15.7859 4.55221,15.2189 C3.36505,14.652 2.33604,13.8009 1.55634,12.7413 C0.776635,11.6816 0.270299,10.446 0.0821822,9.14392 C0.00321229,8.59731 0.382309,8.09018 0.928918,8.01121 C1.47553,7.93224 1.98266,8.31133 2.06163,8.85794 C2.20272,9.83451 2.58247,10.7612 3.16725,11.556 C3.75203,12.3507 4.52378,12.989 5.41415,13.4142 C6.30452,13.8394 7.28602,14.0385 8.27172,13.9939 C9.25741,13.9492 10.2169,13.6621 11.0651,13.158 C11.9133,12.6539 12.6242,11.9485 13.1346,11.1041 C13.6451,10.2597 13.9395,9.30241 13.9916,8.31708 C14.0437,7.33175 13.8521,6.34877 13.4336,5.45521 C13.178,4.90949 12.8426,4.40741 12.4402,3.96464 L11.7071,4.69779 C11.0771,5.32776 9.99996,4.88159 9.99996,3.99069 L9.99996,1.31133017e-07 L13.9907,1.31133017e-07 Z M1.499979,4 C2.05226,4 2.499979,4.44772 2.499979,5 C2.499979,5.55229 2.05226,6 1.499979,6 C0.947694,6 0.499979,5.55228 0.499979,5 C0.499979,4.44772 0.947694,4 1.499979,4 Z M3.74998,1.25 C4.30226,1.25 4.74998,1.69772 4.74998,2.25 C4.74998,2.80229 4.30226,3.25 3.74998,3.25 C3.19769,3.25 2.74998,2.80228 2.74998,2.25 C2.74998,1.69772 3.19769,1.25 3.74998,1.25 Z M6.99998,0 C7.55226,0 7.99998,0.447716 7.99998,1 C7.99998,1.55229 7.55226,2 6.99998,2 C6.44769,2 5.99998,1.55229 5.99998,1 C5.99998,0.447716 6.44769,0 6.99998,0 Z"></path> </g></svg></button>
                  
                 <div class="justify-content-end d-flex">
                  <div class="dropdown flex-md-grow-1 flex-xl-grow-0">
                    
                      <span id="statusText" style="color:orange"></span>
                  
                    
                  </div>
                 </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            
            <div class="col-md-6 grid-margin stretch-card">
              <div class="card tale-bg">
                <div class="card-people mt-auto">
                  <img src="https://images.unsplash.com/photo-1549002942-c6af9c116f79?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OXx8c3VubGlnaHR8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60" height="300px;" alt="people" id="statusPic">
                  <div class="weather-info">
                    <div class="d-flex">
                      <div>
                        <h2 class="mb-0 font-weight-normal"><strong id="temps"></strong><sup>C</sup></h2>
                      </div>
                      <div class="ml-2">
                        <h4 class="location font-weight-normal">Nairobi</h4>
                        <h6 class="font-weight-normal">Kenya</h6>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6 grid-margin transparent">
              
              <div class="row">
                <div class="col-md-6 mb-4 stretch-card transparent" >
                  <div class="card card-tale" style="background-color: yellowgreen;">
                    <div class="card-body">
                      <p class="mb-4"># of employees</p>
                      <a class="fs-30 mb-2" href="{% url 'management_list_employee' %}">{{employees | length}}</a>
                      
                    </div>
                  </div>
                
                </div>
                <div class="col-md-6 mb-4 stretch-card transparent">
                  <div class="card card-dark-blue">
                    <div class="card-body">
                      <p class="mb-4">my applications</p>
                      <a class="fs-30 mb-2" href="{% url 'management_list_approvals' %}">{{todos | length}}</a>
                      
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-4 mb-lg-0 stretch-card transparent">
                  <div class="card card-light-blue">
                    <div class="card-body">
                      <p class="mb-4">latest</p>
                      <p class="fs-30 mb-2">{{event | length}}</p>
                      
                    </div>
                  </div>
                </div>
                <div class="col-md-6 stretch-card transparent">
                  <div class="card card-light-danger">
                    <div class="card-body">
                      <p class="mb-4">downloads updates</p>
                      <p class="fs-30 mb-2">{{payrolls | length}}</p>
                      
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        
          <div class="row">
            <div class="col-md-4 stretch-card grid-margin"  style="overflow-y: scroll; height: 300px;">
              <div class="card">
                <div class="card-body">
                  <p class="card-title mb-0">System Generated Files</p>
                  <div class="table-responsive">
                    <table class="table table-borderless">
                      <thead>
                        <tr>
                          <th class="pl-0  pb-2 border-bottom">Id</th>
                          
                          <th class="border-bottom pb-2">Created</th>
                          <th class="border-bottom pb-2">Download </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% cache 500 payroll_list %}
                        {% for payroll in payrolls %}
                        <tr>
                          <td class="pl-0">{{payroll.employee_id}}</td>
                          <td><p class="mb-0"><span class="font-weight-bold mr-2"></span>{{payroll.created_date}}{{payroll.created_time}}</p></td>
                          <td class="text-muted"><a href="{% url 'payroll-payslip' payroll.sign_id %}" download><i class="ti-download"></i></a></td>
                        </tr>
                        {% endfor %}
                        {% endcache %}
                        
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-2 stretch-card grid-margin">
              <div class="row">
                <div class="col-md-12 grid-margin stretch-card">
                  <div class="card">
                    <div class="card-body">
                      <p class="card-title">Departments</p>
                      <div class="charts-data">
                        <div class="mt-3">
                          <p class="mb-0">HR department</p>
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="progress progress-md flex-grow-1 mr-4">
                              <div class="progress-bar bg-inf0" role="progressbar" style="width: 0%" aria-valuenow="95" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <p class="mb-0">{{department | length }}</p>
                          </div>
                        </div>
                        
                       
                       
                      </div>  
                    </div>
                  </div>
                </div>
                <div class="col-md-12 stretch-card grid-margin grid-margin-md-0">
                  <div class="card data-icon-card-primary">
                    <div class="card-body">
                      <p class="card-title text-white">Announcements</p>                      
                      <div class="row">
                        <div class="col-8 text-white">
                          <h3>{{event | length}}</h3>
                          <p class="text-white font-weight-500 mb-0">{{event.details}}</p>
                          <p class="text-white font-weight-500 mb-0"> </p>
                        </div>
                        <div class="col-4 background-icon">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>.
              </div>
            </div>
            <div class="col-md-6 stretch-card grid-margin" >
              <div class="card" style="overflow-y:scroll; height:500px;">
                <div class="card-body">
                  <p class="card-title">To do</p>
                                                                                                                                                                                          
                    
                        <div class="li-wrapper px-3" >
                          <ul class="d-flex flex-column-reverse todo-list">
                            
                            {% for todo in todos %}
                            <li>
                              <div class="form-check">
                                <label class="form-check-label">
                                  <input class="checkbox" type="checkbox" onclick="getPk('{{todo.0}}')">
                                  {{todo.5}} <strong style="color:green">{{todo.6}}</strong> <small> {{todo.2}}</small>
                                </label>
                              </div>
                              &nbsp;&nbsp;&nbsp;&nbsp;
                              <a href="{{todo.4}}" download><i class="remove ti-download"></i>attachment</a>
                              &nbsp;&nbsp;&nbsp;
                              <a onclick="approveModal('{{todo.0}}','{{todo.4}}')" class="btn btn-outline"><i class="fa fa-check"></i></a>
                             
                              
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                              <a class="btn btn-danger" onclick="reject('{{todo.0}}');"><i class="remove ti-close"></i></a>
                            </li>
                            {% endfor %}

                         
                            
                            
                            
                            
                          </ul>
                        </div>
                      
               
                </div>
              </div>
            </div>
          </div>
          <!--
          <div class="row">
            <div class="col-md-6 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <p class="card-title">Attendance trends</p>
                  <p class="font-weight-500"></p>
                 
                  <canvas id="order-chart"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-6 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                 <div class="d-flex justify-content-between">
                  <p class="card-title">expected vs Actual</p>
                  <a href="#" class="text-info">View all</a>
                 </div>
                  <p class="font-weight-500"></p>
                  <div id="sales-legend" class="chartjs-legend mt-4 mb-2"></div>
                  <canvas id="sales-charts"></canvas>
                </div>
              </div>
            </div>
          </div>
        -->
          
         
          
          <div class="row">
            <div class="col-md-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <p class="card-title">My attendance</p>
                  <div class="row">
                    <div class="col-12">
                      <div class="table-responsive">
                        <table id="newemp" class="display expandable-table" style="width:100%">
                          <thead>
                            <tr>
                              <th>Employee #</th>
                              <th>Day</th>
                              <th>Days</th>
                              <th>Hours</th>
                              <th>Deductions</th>
                              <th>Remaining Leave Days</th>
                              <th>Status</th>
                          
                              <th>Remarks</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% cache 500 attendance_list %}
                            {% for att in attendance %}
                            <tr>
                                
                                <td>{{att.employee.emp_id}}</td>
                                <td>{{att.day}}</td>
                                <td>{{att.days}}</td>
                                <td>{{att.hours}}</td>
                                <td>{{att.deductions}}</td>
                                <td>{{att.leave_days}}</td>
                                <td>{{att.status}}</td>
                                <td>{{att.remarks}}</td>
                            </tr>
                            {% endfor %}
                            {% endcache %}
                          </tbody>
                      </table>
                      </div>
                    </div>
                  </div>
                  </div>
                </div>
              </div>
            </div>
        </div>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#approveModal" id="approveModalBtn" style="display:none">
          
        </button>
        
        <!-- Modal -->
        <div class="modal fade" id="approveModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">approve</h5>
                <div id="loaders2" style="display: none;">
                  <div class="spinner-grow text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                  </div>
                  <div class="spinner-grow text-secondary" role="status">
                    <span class="sr-only">Loading...</span>
                  </div>
                  <div class="spinner-grow text-success" role="status">
                    <span class="sr-only">Loading...</span>
                  </div>
                  </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <a onclick="hideDetails()"><i class="ti-arrow-circle-up"></i></a>
                <a onclick="showDetails()"><i class="ti-arrow-circle-down"></i></a>
                <div style="color:yellowgreen; overflow-y:scroll" id="detDiv" style="height:400px">
                  <strong id="det"></strong>
                  <a href="" download><i class="ti-download" id="attach"></i></a>
                </div>
                <br><br>
                <form class="forms-sample">
                  <div class="form-group">
                    <label for="exampleInputName1">id</label>
                    <input type="text" class="form-control" id="approvePk" placeholder="Name">
                  </div>
                  
                  <div class="form-group">
                    <label for="exampleSelectGender">status</label>
                      <select class="form-control" id="approveStatus"> 
                        <option value="approve">Approve</option>
                        <option value="reject">Reject</option>
                      </select>
                    </div>
                  
                 
                  <div class="form-group">
                    <label for="exampleTextarea1">Textarea</label>
                    <textarea class="form-control" id="approveComments" rows="4"></textarea>
                  </div>
                  <button type="button" class="btn btn-primary mr-2" onclick="doneApprove()">Submit</button>
                
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                
              </div>
            </div>
          </div>
        </div>

        <!-- content-wrapper ends -->
        <!-- partial:partials/_footer.html -->
        <footer class="footer">
          
        </footer>
        <!-- partial -->
      </div>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
      <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
      <script>
    new DataTable('#newemp');
     
// approval modal
function approveModal(id,link){

    
  $("#approveModalBtn").click()

  $("#approvePk").val(id)
  
  //$("#attach").href(link)

  $.ajax({

      type:"POST",
      url:"{% url 'management_view_approval_details' %}",
      data:{

         id:id
      },
      beforeSend:function(){
                $("#loaders2").show()
             },
      success:function(data,status){
       
        document.getElementById("detDiv").innerHTML = data
      },
      complete:function(){
                
                $("#loaders2").hide()
                
  
               }
  })
}

function hideDetails(){
    
    $("#detDiv").hide()
}
function showDetails(){
    
    $("#detDiv").show()
}
function doneApprove(){

  $.ajax({
    type:"post",
    url:"{% url 'management_approve_by_details' %}",
    data:{

      id:$("#approvePk").val(),
      status:$("#approveStatus").val(),
      comments:$("#approveComments").val(),
      csrfmiddlewaretoken:'{{ csrf_token }}'



    },
    beforeSend:function(){
                $("#loaders2").show()
             },
            
    success:function(data,status){
      alert(data)
    },
    complete:function(){
                
                $("#loaders2").hide()
               
                location.reload()
               }
     
  })

}
    // approve todo 
function getPk(id){
 
   $.ajax({

      type:"post",
      url:"{% url 'management_approve' %}",
      data:{
        id:id,
        csrfmiddlewaretoken:'{{ csrf_token }}'

      },
      beforeSend:function(){
                $("#loaders5").show()
             },

      success:function(data,status){
        alert(data)
      },
      complete:function(){
                
                $("#loaders5").hide()
                location.reload()
  
               }
   })
}

// reject todo 

function reject(id){

            $.ajax({

          type:"post",
          url:"{% url 'management_reject' %}",
          data:{
            id:id,
            csrfmiddlewaretoken:'{{ csrf_token }}'

          },
          beforeSend:function(){
                $("#loaders5").show()
             },
          success:function(data,status){
            alert(data)
          },
          complete:function(){
                
                $("#loaders5").hide()
                location.reload()
  
               }
          })

}

// view application details

function viewMore(){

    $("#viewMoreBtn").click()
}

//============================== fetch weather data==========================================

function getWeatherData(lat,lon){

var url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=4fa5737c18f70c57a4aa1c17b818a7b3`
  fetch(url).then(
    function(resp){
      return resp.json()
    }
  ).then(
    function(data){
      console.log(data.weather[0].main)
      document.getElementById("temps").innerHTML =  Math.round(parseFloat(data.main.temp)-273.15)
    }
  )
}

getWeatherData('-1.292066','36.821945')

function workStatus(){

  var work_time = 'https://images.unsplash.com/photo-1506452819137-0422416856b8?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8d29yayUyMHRpbWV8ZW58MHx8MHx8fDA%3D'
  var tea_time = 'https://images.unsplash.com/photo-1588710962678-845d46818fd0?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YnJlYWslMjB0aW1lfGVufDB8fDB8fHww'
  var lunch_break = 'https://images.unsplash.com/photo-1567934124115-2eca8953796b?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTB8fHBsYXRlfGVufDB8fDB8fHww'
  var rest_time = 'https://images.unsplash.com/photo-1586084531072-e03cbf17afa6?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cmVzdHxlbnwwfHwwfHx8MA%3D%3D'

  const today = new Date();
          
  let h = today.getHours();
 
  if(h >= 8 && h <10){
   
      document.getElementById("statusPic").src = work_time
      document.getElementById("statusText").innerHTML = "Work time"

  }else if (h==10){
     
    document.getElementById("statusPic").src = tea_time
    document.getElementById("statusText").innerHTML = "Tea Break"
  } else if (h>=11 && h<13){
    document.getElementById("statusPic").src = work_time
    document.getElementById("statusText").innerHTML = "Work time"
  }else if (h==13){
    document.getElementById("statusPic").src = lunch_break
    document.getElementById("statusText").innerHTML = "Lunch Break"
  }else if(h>=14 && h<=17){
    document.getElementById("statusPic").src = work_time
    document.getElementById("statusText").innerHTML = "Work time"
  }
  else{
    document.getElementById("statusPic").src = rest_time
    document.getElementById("statusText").innerHTML = "Rest"
  }
}
workStatus()
setInterval(workStatus,8000)

// ============clear cache =======================
function clearCache(){


   $('head').append(`


<meta http-equiv='cache-control' content='no-cache'> 
<meta http-equiv='expires' content='0'> 
<meta http-equiv='pragma' content='no-cache'> 
   
   `)

   location.reload()
}

      </script>
{% endblock content %}
