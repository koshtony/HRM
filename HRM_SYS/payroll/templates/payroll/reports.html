{% extends 'management/base.html' %}
{% load crispy_forms_tags %}
{% block content %} 



<!--details modal-->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#sumModal" style="display:none" id="detailModal">details</button>

<div class="modal fade" id="sumModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-lg" role="document">
      <div class="modal-content">
        <div class="modal-header"  style="background-color:yellowgreen">
          <h5 class="modal-title" id="exampleModalLongTitle" id="orgName"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div id="loaders22" style="display: none;">
          <div class="spinner-grow text-primary" role="status">
            <span class="sr-only">Loading...</span>
          </div>
          <div class="spinner-grow text-secondary" role="status">
            <span class="sr-only">Loading...</span>
          </div>
          <div class="spinner-grow text-success" role="status">
            <span class="sr-only">Loading...</span>
          </div>
          </div>
        <div class="modal-body">
            <div class="row">

                <div class="col">
                    <div>
                        <h4><span>payroll total</span></h4>
                    </div>
                    <br>
                    <div>
                        <h4 id="totalCost" style="font-weight: bold; color:green"></h4>
                    </div>
                </div>
                <div class="col">

                    <div>
                        <h4><span>pay run</span></h4>
                    </div>
                    <br>
                    <div>
                        <h4 id="payId" style="font-weight: bold;"></h4>
                    </div>
                    
                </div>
            </div>
            <br>
            <button class="btn btn-success" onclick="approvePay();"> <i class="ti-check"></i>approve</button>
           
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
         
        </div>
      </div>
    </div>
  </div>

<!-- edit modal iframe-->

<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#payrollDetailModal" id="iframeBtn" style="display:none">edit modal</button>

<div class="modal fade" id="payrollDetailModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">check details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <iframe id="eFrame" width="100%" height="1000" style="overflow-x: scroll;"></iframe>
             
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          
        </div>
      </div>
    </div>
  </div>



<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#emailModal" id="emailBtn" style="display:none">edit modal</button>

<div class="modal fade" id="emailModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">sure you want to email?</h5>
          <div id="loaders2" style="display: none;">
            <div class="spinner-grow text-primary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <div class="spinner-grow text-secondary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <div class="spinner-grow text-success" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            </div>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            
             <input type="text" class="form-control" id="emailPayrollId">

             <button type="button" class="btn btn-outline" onclick="emailPayroll()" style="margin-left:200px;"><i class="fa fa-plane" style="color:green"></i></button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          
        </div>
      </div>
    </div>
  </div>

  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#imageGenModal" id="imageGenIframeBtn" style="display:none">
    show Image
   </button>

  <div class="modal fade" id="imageGenModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">image</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <img id="imageGenFrame" width="100%" style="overflow-x: scroll;">
             
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
         
        </div>
      </div>
    </div>
  </div>

  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#mapGenModal" id="mapGenIframeBtn" style="display:none">
    show map
   </button>

  <div class="modal fade" id="mapGenModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">show location</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <iframe id="mapGenFrame" width="100%" height="800" style="overflow-x: scroll;"></iframe>
             
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          
        </div>
      </div>
    </div>
  </div>

<div class="main-panel">
    <!-- row -->
    <div class="content-wrapper">
            
        <div class="row page-titles mx-0">
            <div class="col-sm-6 p-md-0">
                <div class="welcome-text">
                    <h4>Payroll</h4>
                </div>
            </div>
            
        </div>
        
        <div class="row">
            <div class="col-lg-12">
                <ul class="nav nav-pills mb-3">

                    <li class="nav-item"><a href="#grid-view" data-toggle="tab" class="nav-link btn-primary mr-1 show active"><i class="ti-list"></i>general</a></li>
                    <li class="nav-item"><a href="#settings" data-toggle="tab" class="nav-link btn-primary" style="background-color: orange;"><i class="ti-filter"></i>generate</a></li>
                    <li class="nav-item"><a href="#groups" data-toggle="tab" class="nav-link btn-primary" style="background-color: blue;"><i class="fa fa-wrench"></i>groups</a></li>
                </ul>
            </div>
            <div class="col-lg-12">
                <div class="row tab-content">
                   
                    <div id="grid-view" class="tab-pane fade show active col-lg-12">
                      <div id="loaders45" style="display: none;">
                        <div class="spinner-grow text-primary" role="status">
                          <span class="sr-only">Loading...</span>
                        </div>
                        <div class="spinner-grow text-secondary" role="status">
                          <span class="sr-only">Loading...</span>
                        </div>
                        <div class="spinner-grow text-success" role="status">
                          <span class="sr-only">Loading...</span>
                        </div>
                        </div>
                        
                        <div class="row">
                          <div class="col-4">
                            <label>select action</label>
                        <select class="form-control" id="action">
                          <option value="audit">Approve</option>
                          <option value="revert">Revert</option>
                          <option value="delete">Delete</option>
                          
                        </select>
                        </div>
                        <div class="col-4">
                        <button class="btn btn-light" onclick="performAction();"><svg fill="#10d513" height="34px" width="34px" version="1.1" id="XMLID_232_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="action"> <g> <path d="M1.7,23.7l-1.4-1.4l2.4-2.4c-2.4-2.8-2.2-7,0.4-9.6l1.7-1.7l10.7,10.7l-1.6,1.6c-1.4,1.4-3.2,2.1-5.1,2.1 c-1.7,0-3.3-0.6-4.6-1.7L1.7,23.7z M5,19.4c1,1,2.3,1.5,3.7,1.5s2.7-0.5,3.7-1.5l0.2-0.2l-7.8-7.9l-0.3,0.3c-2,2-2,5.2,0,7.2 L5,19.4z M19.2,15.3l-2.5-2.5l-2.3,2.3L13,13.8l2.3-2.3l-2.8-2.8L10.2,11L8.8,9.6l2.3-2.3L8.6,4.8l1.6-1.6 c1.4-1.4,3.2-2.1,5.1-2.1c1.7,0,3.3,0.6,4.6,1.7l2.4-2.4l1.4,1.4l-2.4,2.4c2.4,2.8,2.2,7-0.4,9.6L19.2,15.3z M11.4,4.6l7.8,7.9 l0.3-0.3c2-2,2-5.2,0-7.2L19,4.4c-1-1-2.3-1.5-3.7-1.5s-2.7,0.5-3.7,1.5L11.4,4.6z"></path> </g> </g> </g></svg>Proceed</button>
                        </div>
                        <div class="col-4">
                          <button class="btn btn-outline" onclick="htmlTableToExcelto('xlsx')"><svg width="34px" height="34px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#0af038"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M17 17H17.01M17.4 14H18C18.9319 14 19.3978 14 19.7654 14.1522C20.2554 14.3552 20.6448 14.7446 20.8478 15.2346C21 15.6022 21 16.0681 21 17C21 17.9319 21 18.3978 20.8478 18.7654C20.6448 19.2554 20.2554 19.6448 19.7654 19.8478C19.3978 20 18.9319 20 18 20H6C5.06812 20 4.60218 20 4.23463 19.8478C3.74458 19.6448 3.35523 19.2554 3.15224 18.7654C3 18.3978 3 17.9319 3 17C3 16.0681 3 15.6022 3.15224 15.2346C3.35523 14.7446 3.74458 14.3552 4.23463 14.1522C4.60218 14 5.06812 14 6 14H6.6M12 15V4M12 15L9 12M12 15L15 12" stroke="#15c638" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>download filtered</button>
                        </div>
                        </div>
                        <div>
                      
                        </div>
                        <div class="row">
                            <div class="table-responsive">
                                <table  class="table table-striped"  id="payroll" style="zoom: 85%; font-weight: bolder;">
                                    <thead style="background-color: yellowgreen;">
                                        <tr>
                                          <th><div class="form-check">
                                            <input class="checkall" style="zoom: 2;" type="checkbox" value="" id="selectAll">
                                            <label class="form-check-label" for="flexCheckIndeterminate">
                                              select all
                                            </label>
                                          </div></th>
                                            <th>Docs</th>
                                            <th>Audit Details</th>
                                            <th>Created</th>
                                            <th>Status</th>
                                            <th>Payroll Id</th>
                                            <th>Employee Id</th>
                                            
                                            <th>First Name</th>
                                          
                                            <th>National Id</th>
                                            <th>Phone</th>
                                            <th>Role</th>
                                            <th>Account No</th>
                                            <th>Salary</th>
                                            <th>Leave Days</th>
                                            <th>Days</th>
                                            <th>Overtime Pay</th>
                                            <th>Incentives</th>
                                            <th>Deductions</th>
                                            <th>Loan Deductions</th>
                                            <th>Welfare Deductions</th>
                                            <th>Gross Pay</th>
                                            <th>Taxable Income</th>
                                            <th>PAYE</th>
                                            <th>NHIF</th>
                                            <th>NSSF</th>
                                            <th>Housing</th>
                                            <th>Others</th>
                                            <th>Net Pay</th>

                                           
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for val in payrolls %}
                                        
                                        <tr>
                                          <td>
                                            <div class="form-check">
                                              <input class="checkboxall"  type="checkbox" value="{{val.pk}}" id="flexCheckIndeterminate">
                                              <label class="form-check-label" for="flexCheckIndeterminate">
                                                select
                                              </label>
                                              
                                            </div>
                                          </td>
                                            <td>
                                                <a href="{% url 'payroll-payslip' val.sign_id %}" download><i class="ti-download"></i></a>
                                            </td>
                                            <td>
                                                <a onclick="editIframe('{{val.pk}}')"><i class="ti-pencil"></i></a>
                                            </td>
                                            <td>
                                                {{val.created_date}} {{val.created_time}}
                                            </td>
                                            {% if val.status == "audited" %}
                                            <td style="background-color: green;">
                                                {{val.status}}
                                            </td>
                                            {% else %}
                                            <td style="background-color:red;">
                                                {{val.status}}
                                            </td>
                                            {% endif %}
                                            <td>
                                                {{val.payroll_id}}
                                            </td>
                                            <td>
                                                {{val.employee_id}}

                                            </td>
                                            <td>
                                                {{val.name}}
                                            </td>
                                            <td>
                                                {{val.id_no}}
                                            </td>
                                            <td>
                                                {{val.phone}}
                                            </td>
                                            <td>
                                                {{val.role}}
                                            </td>
                                            <td>
                                                {{val.account_no}}
                                            </td>
                                            <td>
                                                {{val.basic_salary}}
                                            </td>
                                            <td>
                                                {{val.leave_days}}
                                            </td>
                                            <td>
                                                {{val.total_days}}
                                            </td>
                                            <td>
                                                {{val.overtime_pay}}
                                            </td>
                                            <td>
                                                {{val.incentives}}
                                            </td>
                                            <td>
                                                {{val.deductions}}
                                            </td>
                                            <td>
                                                {{val.loan_deductions}}
                                            </td>
                                            <td>
                                                {{val.welfare_deductions}}
                                            </td>
                                            <td>
                                                {{val.gross_pay}}
                                            </td>
                                            <td>
                                                {{val.taxable_income}}
                                            </td>
                                            <td>
                                                {{val.tax}}
                                            </td>
                                            <td>
                                                {{val.nhif}}
                                            </td>
                                            <td>
                                              {{val.nssf}}
                                          </td>
                                            <td>
                                                {{val.housing}}
                                            </td>
                                            <td>
                                                {{val.others}}
                                            </td>
                                            <td>
                                                {{val.net_pay}}
                                            </td>
                                           
                                            
                                        </tr>
                                        {% endfor %}
                                        
                                    </tbody>
                                </table>
                            </div>
                            
                        </div>
                    </div>
                    <div id="settings" class="tab-pane fade col-lg-12">
                        <div class="row">
                            <div class="col-md-6 mb-4 mb-lg-0 stretch-card transparent">
                            <div class="card"  style="width:400px; overflow-x: scroll;">
                                <div id="loaders3" style="display: none;">
                                    <div class="spinner-grow text-primary" role="status">
                                      <span class="sr-only">Loading...</span>
                                    </div>
                                    <div class="spinner-grow text-secondary" role="status">
                                      <span class="sr-only">Loading...</span>
                                    </div>
                                    <div class="spinner-grow text-success" role="status">
                                      <span class="sr-only">Loading...</span>
                                    </div>
                                    </div>
                                    <div class="card-body">
                                        <h4> pay period</h4>
                                        <div class="form-group row">
                                            
                                       
                                            <label>from</label>
                            <input type="date" class="form-control" id="date1">
                        
                           
                            <label>to</label>
                            <input type="date" class="form-control" id="date2">
                           

                         
                            </div>
                            <div class="form-group row">
                              <label>type</label>
                              <select class="form-control" id="payroll_type">
                                <option value="flat">flat payroll</option>
                                <option value="inclusive">attendance based payroll</option>
                              </select>
                            </div>
                            <a class="btn btn-primary" onclick="filter()"><svg fill="#06ed02" width="24px" height="24px" viewBox="-3.5 0 19 19" xmlns="http://www.w3.org/2000/svg" class="cf-icon-svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M11.146 2.964v13.212a.476.476 0 0 1-.475.475H1.33a.476.476 0 0 1-.475-.475V2.964a.476.476 0 0 1 .475-.475h9.342a.476.476 0 0 1 .475.475zm-1.108.633H1.962v2.726h8.076zM3.653 8.608a.792.792 0 0 0-.791-.791h-.003a.792.792 0 1 0 0 1.583h.003a.792.792 0 0 0 .791-.792zm0 2.634a.792.792 0 0 0-.791-.791h-.003a.792.792 0 1 0 0 1.583h.003a.792.792 0 0 0 .791-.792zm0 2.634a.792.792 0 0 0-.791-.791h-.003a.792.792 0 1 0 0 1.583h.003a.792.792 0 0 0 .791-.792zm3.04-2.634a.792.792 0 0 0-.792-.791H5.9a.792.792 0 1 0 0 1.583.792.792 0 0 0 .792-.792zm0 2.634a.792.792 0 0 0-.792-.791H5.9a.792.792 0 1 0 0 1.583.792.792 0 0 0 .792-.792zm.048-5.268a.792.792 0 0 0-.791-.791h-.005a.792.792 0 0 0 0 1.583h.005a.792.792 0 0 0 .791-.792zm3.086 0a.792.792 0 0 0-.792-.791h-.002a.792.792 0 0 0 0 1.583h.002a.792.792 0 0 0 .792-.792zm0 2.587a.792.792 0 1 0-1.584 0v2.681a.792.792 0 0 0 1.584 0z"></path></g></svg>generate</a>

                            <h3>preview</h3>
                            <table  class="table table-striped"  id="paySummary" style="zoom: 85%; font-weight: bolder;">
                                <thead style="background-color: yellowgreen;">
                                    <tr>
                                        <th>Payroll id</th>
                                        <th>Organisation</th>
                                        <th>Sign Id</th>
                                       
                                        <th>Created</th>
                                        <th>View All</th>
                                      
                                        
                                       
                                       
                                    </tr>
                                </thead>
                                <tbody id="payrollFilt">
                                    
                                </tbody>
                            </table>

                                    </div>
                                    </div>
                                    
                            </div>
                            
                            <div class="col-md-6 mb-4 mb-lg-0 stretch-card transparent" style="overflow-x: scroll;" id="pSum">
                               
                                <table  class="table table-striped"  id="paygen" style="zoom: 100%; font-weight: bolder;">
                                    <thead style="background-color: yellowgreen;">
                                        <tr>
                                            <th>Payroll Id</th>
                                            <th>Total Payable</th>
                                            <th>Size</th>
                                            <th>Summary</th>
                                            <th>View All</th>
                                            <th>Action</th>
                                          
                                            
                                           
                                           
                                        </tr>
                                    </thead>
                                    <tbody id="payrollGroup">
                                        {% for payroll in by_payroll_ids  %}
                                        <tr>
                                            <td>{{payroll.payroll_id}}</td>
                                            <td>{{payroll.total_amount}}</td>
                                            <td>{{payroll.size}}</td>
                                            <td><a href="{% url 'payroll-summary' payroll.payroll_id %}">summary</a></td>
                                            <td><a class="btn btn-primary" onclick="showDetails('{{payroll.payroll_id}}')"><i class="ti-check"></i></a></td>
                                            <td><a onclick="emailModal('{{payroll.payroll_id}}')"><i class="fa fa-envelope"></i>email</a></td>
                                           
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                               
                            </div>
                       </div>
                       <div class="row">



                       </div>
            </div>
            <div id="groups" class="tab-pane fade show col-lg-12">
                <div class="row">
                   
                    <div class="col-md-6 grid-margin stretch-card" id="list-view">
                      <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table  class="table table-striped"  id="payroll" style="zoom: 85%; font-weight: bolder;">
                                <thead>
                                    <tr>
                                        <th>Organisation</th>
                                        <th>Group</th>
                                        <th>Formula</th>
                                        <th>Relief</th>
                                        <th>NSSF</th>
                                        <th>NHIF</th>
                                        <th>Housing</th>
                                        <th>Others</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for setting in settings %}
                                    <tr>
                                        <td>{{setting.org_name}}</td>
                                        <td>{{setting.category}}</td>
                                        <td>{{setting.tax_rate}}</td>
                                        <td>{{setting.relief}}</td>
                                        <td>{{setting.nssf}}</td>
                                        <td>{{setting.nhif}}</td>
                                        <td>{{setting.health_insurance}}</td>
                                        <td>{{setting.housing}}</td>
                                        <td>{{setting.others}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                </table>
                            
                            
                            </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 grid-margin stretch-card">
                     
                      <div class="card">
                        <div class="card-body">
                          <div>
                          
                          </div>
                            <h4 id="success" style="color:greenyellow"></h4>
                            <div id="loaders6" style="display: none;">
                                <div class="spinner-grow text-primary" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                <div class="spinner-grow text-secondary" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                <div class="spinner-grow text-success" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                </div>
                            <form id="extraPaymentForm" enctype="multipart/form-data" method="POST">
                                {% csrf_token %}
              
                                {% for field in extra_payment_form %}
                                  <div class="form-group">
                                     {{field | as_crispy_field}}
                                  </div>
                                {% endfor %}
                                  
                                 
                                  
                                  
                                 
                                
                                  <button type="submit" class="btn btn-primary mr-2" onclick="loadPayment();">Submit</button>
                                  <button class="btn btn-light">Cancel</button>
                                </form>
                          
                        </div>
                      </div>
                    </div>
                    <div class="col-12 grid-margin stretch-card" id="groups">
                      <div class="card">
                        <div class="card-body">
                          <div id="loaders7" style="display: none;">
                            <div class="spinner-grow text-primary" role="status">
                              <span class="sr-only">Loading...</span>
                            </div>
                            <div class="spinner-grow text-secondary" role="status">
                              <span class="sr-only">Loading...</span>
                            </div>
                            <div class="spinner-grow text-success" role="status">
                              <span class="sr-only">Loading...</span>
                            </div>
                            </div>
                          <h4>group employees</h4>
                          <form class="forms-sample" onsubmit="grouping();">
                            {% csrf_token %}
                          <div class="row">
                          <div class="col-md-6">
                          <div class="form-group">
                            <label>gross range 1</label>
                            <input type="number" class="form-control" id="range1" required>
                          </div>
                          </div>
                          <div class="col-md-6">
                          <div class="form-group">
                            <label>gross range 2</label>
                            <input type="number" class="form-control" id="range2" required>
                          </div>
                          </div>
                          </div>
                          <div class="form-group">
                            <label>select group</label>
                            <select class="form-control" id="group">
                              {% for setting in settings %}
                                <option value="{{setting.category}}">{{setting.category}}</option>
                              {% endfor %}
                            </select>
                          </div>

                          <button class="btn btn-secondary" type="submit">set group</button>

                          </form>
                          
                        </div>
                      </div>
                    </div>
                    
                  </div>
       
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>
<script>
     new DataTable('#attendance');
     new DataTable('#paySummary');
     new DataTable('#paygen');
     new DataTable('#payroll');
     new DataTable('#details');

     function showMap(lat,long){
       

        var mapProp= {
  center:new google.maps.LatLng(lat,long),
  zoom:5,
};
var map = new google.maps.Map(document.getElementById("Map"),mapProp);
     }

    
    function filter(){
       
         if($("#payroll_type").val()=="flat"){
             
          flat()

         }else if($("#payroll_type").val()=="inclusive"){

          inclusive()

         }
    }

function inclusive(){

          $.ajax({

        type:"POST",
        url:"{% url 'payroll-month' %}",
        data:{
            
            date1: $("#date1").val(),
            date2: $("#date2").val(),
            payId: Math.trunc(Date.now() + Math.random()) ,
            csrfmiddlewaretoken:'{{ csrf_token }}',

            
        },
        beforeSend:function(){
            $("#loaders3").show()
        },
        success:function(data,status){
          
            var data = JSON.parse(data)
            $("#payrollFilt").html('')
            for(key in data){
              console.log(data[key])
                $("#payrollFilt").append(
                    `
                    <tr>

                        <td>${data[key]["payroll_id"]}</td>
                        <td>${data[key]["org_name"]}</td>
                        <td>${data[key]["employee_id"]}</td>
                        <td>${data[key]["sign_id"]}</td>
                        <td>${data[key]["created"]}</td>

                    </tr>
                    
                    `
                )
            }
            
            location.reload()
            
        }
        ,
            complete:function(){
            
            $("#loaders3").hide()
            location.reload()

          }
            
        })

}

function flat(){
  confirm("This may take some time: estimated time 5-10 mins")

  $.ajax({

type:"POST",
url:"{% url 'payroll-flat' %}",
data:{
    
    date1: $("#date1").val(),
    date2: $("#date2").val(),
    payId: Math.trunc(Date.now() + Math.random()) ,
    csrfmiddlewaretoken:'{{ csrf_token }}',

    
},
beforeSend:function(){
    $("#loaders3").show()
},
success:function(data,status){
  
    var data = JSON.parse(data)
    $("#payrollFilt").html('')
    for(key in data){
      console.log(data[key])
        $("#payrollFilt").append(
            `
            <tr>

                <td>${data[key]["payroll_id"]}</td>
                <td>${data[key]["org_name"]}</td>
                <td>${data[key]["employee_id"]}</td>
                <td>${data[key]["sign_id"]}</td>
                <td>${data[key]["created"]}</td>

            </tr>
            
            `
        )
    }
    
    location.reload()
    
}
,
    complete:function(){
    
    $("#loaders3").hide()
    location.reload()

  }
    
})
}


    function showDetails(id){
        $("#payId").html(id)
       $("#detailModal").click()
      
        $.ajax({
            type:"post",
            url:"{% url 'payroll-details' %}",
            data:{
                    id:id,
                    csrfmiddlewaretoken:'{{ csrf_token }}'

            },
            success:function(data,status){
            
                var data = JSON.parse(data)
               $("#totalCost").html("Ksh "+data["cost"])
               $("#payrun").html("Ksh "+data["created"])
                

                


            }
        })

    }


    function approvePay(){
        
        var payroll_id = $("#payId").html()

        $.ajax({
            type:"post",
            url:"{% url 'payroll-check' %}",
            data:{
                id:payroll_id,
                csrfmiddlewaretoken:'{{ csrf_token }}'
            },
            beforeSend:function(){
                $("#loaders22").show()
             },
            success:function(data,status){

                alert(data)
            },
            complete:function(){
                
                $("#loaders22").hide()
                location.reload()
  
               }

        })
    }

    function emailModal(id){
       
        $("#emailBtn").click()
        $("#emailPayrollId").val(id)

    }

    function emailPayroll(){
        
        var id = $("#emailPayrollId").val()
        alert(id)
        $.ajax({
            type:"post",
            url:"{% url 'payroll-email' %}",
            data:{
                payroll_id:id,
                csrfmiddlewaretoken:'{{ csrf_token }}'
            },
             
            beforeSend:function(){
                $("#loaders2").show()
             },
            success:function(data,status){

                alert(data)
            },
            complete:function(){
                
                $("#loaders2").hide()
                location.reload()
  
               }

        })        
    }
    
    function editIframe(id){
        
        $("#iframeBtn").click()
        document.getElementById("eFrame").src = 'edit_payroll/'+id
       
        
        
        

    }

    function htmlTableToExcel(type){
 var data = document.getElementById('attendance');
 var excelFile = XLSX.utils.table_to_book(data, {sheet: "sheet1"});
 XLSX.write(excelFile, { bookType: type, bookSST: true, type: 'base64' });
 XLSX.writeFile(excelFile, 'attendance.' + type);
}

function htmlTableToExcelto(type){
 var data = document.getElementById('payroll');
 var excelFile = XLSX.utils.table_to_book(data, {sheet: "sheet1"});
 XLSX.write(excelFile, { bookType: type, bookSST: true, type: 'base64' });
 XLSX.writeFile(excelFile, 'payroll.' + type);
}
    
       
function showMap(lat,long){
     
     $("#mapGenIframeBtn").click()
     var new_url = lat+"_"+long
  
   
     document.getElementById("mapGenFrame").src = 'show_map/'+new_url
 }

 
 function showImage(image_url){
    
    $("#imageGenIframeBtn").click()
    document.getElementById("imageGenFrame").src = image_url
}

//$("#payId").val(Math.trunc(Date.now() + Math.random()))

// uploading extra payments

function loadPayment(){
  
  $("#extraPaymentForm").submit(function(e){
   e.preventDefault()
    
   $form = $(this)
   var formData = new FormData(this);
   alert("p")
   $.ajax({
     method:"post",
     url:"{% url 'payroll-extra-payments' %}",
     data:formData,
     processData: false,
contentType: false,
beforeSend:function(){
             $("#loaders6").show()
          },

     success:function(data,status){
       $("#success").html(data)
     },
     complete:function(){
             
             $("#loaders6").hide()
             //location.reload()

            }
   })
  })

}


function grouping(){

  event.preventDefault();
  
  $.ajax({

     type:"POST",
     url:"{% url 'payroll-grouping' %}",
     data:{

         range1:$("#range1").val(),
         range2:$("#range2").val(),
         group: $("#group").val(),
         csrfmiddlewaretoken:'{{ csrf_token }}'


     },
     beforeSend:function(){
             $("#loaders7").show()
          },
     success:function(data,status){

         alert(data)
     },
     complete:function(){
             
             $("#loaders7").hide()
             //location.reload()

            }

  })

}

// select all rows of individual payroll

$(document).ready(function(){
$("#selectAll").click(function(){
        if(this.checked){
            $('.checkboxall').each(function(){
                $(".checkboxall").prop('checked', true);
            })
        }else{
            $('.checkboxall').each(function(){
                $(".checkboxall").prop('checked', false);
            })
        }
    });
});


// post id of all selected payrolls

function performAction(){

      var checks = []
      $(".checkboxall:checked").each(function(){
      checks.push($(this).val());
      });
      var all_checks = checks.toString()
      $.ajax({
      url:"{% url 'payroll-action' %}",
      type:"POST",
      data:{
        pks:all_checks,
        action:$("#action").val(),
        csrfmiddlewaretoken:'{{ csrf_token }}',
      
      },
      beforeSend:function(){
                  $("#loaders45").show()
      },
      success:function(data,status){
        alert(data)
        const response = confirm("reload to view changes?")
        if (response){
           
           location.reload()
        }
          
      },
      complete:function(){
                  
                  $("#loaders45").hide()
                  

}


})

}
</script>


{% endblock content %}